<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wallet - ElevateFit Admin</title>
<style>
:root {
  --page-bg:#111827;
  --card-bg:#1f2937;
  --accent:#f97316;
  --accent-hover:#ea580c;
  --text:#ffffff;
  --muted:#d1d5db;
  --danger:#ef4444;
  --danger-hover:#dc2626;
}
*{box-sizing:border-box;font-family:'Poppins',sans-serif;margin:0;padding:0}
body{
  background:var(--page-bg);
  color:var(--text);
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:2rem;
}
header{
  width:100%;
  max-width:700px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:2rem;
}
header h1{color:var(--accent);font-size:1.6rem;}
header a{color:var(--muted);text-decoration:none;font-weight:600;}
header a:hover{color:var(--accent);}
main{
  width:100%;
  max-width:700px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:1.5rem;
}
.card{
  background:var(--card-bg);
  padding:2rem;
  border-radius:14px;
  box-shadow:0 8px 30px rgba(0,0,0,0.6);
  width:100%;
  text-align:center;
  border:1px solid rgba(255,255,255,0.05);
}
h2{margin-bottom:0.6rem;color:var(--accent);}
.balance{font-size:2rem;font-weight:700;color:var(--accent);margin-bottom:1rem}
.withdrawn{font-size:1.1rem;color:var(--danger);margin-top:0.5rem;}
button{
  background:var(--danger);
  color:#fff;
  border:none;
  padding:0.7rem 1.2rem;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;
  transition:all 0.3s;
  margin-top:0.5rem;
}
button:hover{background:var(--danger-hover);transform:scale(1.05);}
input{
  padding:0.6rem;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.1);
  background:#fff;
  color:#000;
  width:100%;
  margin-bottom:0.8rem;
}
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:1rem;
  width:100%;
  margin-top:1.5rem;
}
.stat-card{
  background:rgba(255,255,255,0.05);
  padding:1rem;
  border-radius:10px;
  text-align:center;
  border:1px solid rgba(255,255,255,0.05);
}
.stat-card h3{color:var(--accent);margin-bottom:0.3rem;}
.stat-card p{font-size:1.1rem;color:var(--muted);}

.history {
  width:100%;
  max-width:700px;
  background:var(--card-bg);
  border-radius:12px;
  padding:1.5rem;
  margin-top:1rem;
  border:1px solid rgba(255,255,255,0.05);
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
}
.history h3 {
  color:var(--accent);
  margin-bottom:1rem;
  text-align:center;
}
.history table {
  width:100%;
  border-collapse:collapse;
}
.history th, .history td {
  text-align:left;
  padding:0.75rem;
  border-bottom:1px solid rgba(255,255,255,0.1);
}
.history th {color:var(--muted);}
.history td.amount {color:var(--danger);}
.history td.date {color:var(--muted);}
.empty {
  text-align:center;
  color:var(--muted);
  padding:1rem 0;
}
</style>
</head>

<body>
<header>
  <h1>Gym Wallet</h1>
  <a href="admin.html">← Back to Dashboard</a>
</header>

<main>
  <div class="card">
    <h2>Balance</h2>
    <div class="balance" id="balance">₹0</div>

    <input type="number" id="withdrawAmount" placeholder="Withdraw Amount">
    <button onclick="withdrawFunds()">Withdraw Funds</button>

    <div class="withdrawn">Total Withdrawn: <span id="totalWithdrawn">₹0</span></div>

    <div class="stats">
      <div class="stat-card">
        <h3>Total Members</h3>
        <p id="totalMembers">--</p>
      </div>
      <div class="stat-card">
        <h3>Active Memberships</h3>
        <p id="activeMemberships">--</p>
      </div>
      <div class="stat-card">
        <h3>Total Revenue (₹)</h3>
        <p id="revenue">--</p>
      </div>
    </div>
  </div>

  <div class="history">
    <h3>Withdrawal History</h3>
    <table>
      <thead><tr><th>Date</th><th>Amount (₹)</th></tr></thead>
      <tbody id="historyBody"><tr><td colspan="2" class="empty">No withdrawals yet.</td></tr></tbody>
    </table>
  </div>
</main>

<script>
const API = "http://localhost:3000";
let totalRevenue = 0;
let totalWithdrawn = 0;
let history = [];

// Price mapping for plans
const planPrices = {
  "Basic": 999,
  "Standard": 2699,
  "Premium": 4999
};

function updateDisplay() {
  const balance = totalRevenue - totalWithdrawn;
  document.getElementById("balance").textContent = `₹${balance.toLocaleString()}`;
  document.getElementById("totalWithdrawn").textContent = `₹${totalWithdrawn.toLocaleString()}`;
  document.getElementById("revenue").textContent = totalRevenue.toLocaleString();
  renderHistory();
}

async function withdrawFunds() {
  const amt = parseFloat(document.getElementById("withdrawAmount").value);
  if (isNaN(amt) || amt <= 0) return alert("Enter a valid withdrawal amount!");

  const balance = totalRevenue - totalWithdrawn;
  if (amt > balance) return alert("Insufficient balance!");

  const record = {
    id: Date.now(),
    date: new Date().toLocaleString(),
    amount: amt
  };

  await fetch(`${API}/walletTransactions`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(record)
  });

  alert(`₹${amt} withdrawn successfully!`);
  loadWalletData(); // refresh fresh from backend
}

function renderHistory() {
  const tbody = document.getElementById("historyBody");
  tbody.innerHTML = "";
  if (!history.length) {
    tbody.innerHTML = `<tr><td colspan="2" class="empty">No withdrawals yet.</td></tr>`;
    return;
  }
  history.forEach(tx => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${tx.date}</td>
      <td class="amount">₹${tx.amount.toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadWalletData() {
  try {
    const [usersRes, memRes, txRes] = await Promise.all([
      fetch(`${API}/users`),
      fetch(`${API}/memberships`),
      fetch(`${API}/walletTransactions`)
    ]);

    const users = await usersRes.json();
    const memberships = await memRes.json();
    history = await txRes.json();

    document.getElementById("totalMembers").textContent = users.length;
    document.getElementById("activeMemberships").textContent = memberships.length;

    totalRevenue = memberships.reduce((sum, m) => sum + (planPrices[m.planName] || 0), 0);
    totalWithdrawn = history.reduce((sum, tx) => sum + tx.amount, 0);

    updateDisplay();
  } catch (err) {
    console.error("Error loading wallet data:", err);
    alert("Error connecting to JSON server.");
  }
}

loadWalletData();
</script>
</body>
</html>
